---
title: "Demonstration of CREA R package (WIP)"
output: html_notebook
---

## Installing package

```{r results="hide"}
install.packages('devtools')
library(devtools)
url <- "https://gitlab.com/creaaq/crea_r_package"
devtools::install_git(url = url)
```
```{r results="hide"}
library(creadb)
library(dplyr)
library(ggplot2)
library(zoo)
```
## Locations
```{r}
locs <- creadb::locations()
ggplot(data = locs) + geom_sf()
```
## Measurements
### Downloading measurements
Getting data for Delhi and Mumbai. By default, data is averaged by day.
```{r}
meas_cities <- creadb::measurements(city=c('Jaipur','Mumbai', 'Delhi'), date_from='2015-01-01')
meas_cities
```
Filtering values above a certain threshold
```{r}
meas_cities <- creadb::measurements(city=c('Jaipur','Mumbai', 'Delhi'), date_from='2015-01-01',
                            user_filter=function(x){x %>% filter(avg_day<=1000 | pollutant==CO)})
meas_cities
```

Let's first see how many measurements we have, and whether there are holes in time.
```{r}
creadb::plot_measurements_count(meas_cities)
```
Black regions correspond to periods of time without any measurement in this city. Either data is not available or scraping has missed some values.

There are too many locations in Delhi to show in this notebook. We remove Delhi from the demo dataset.
```{r}
meas_cities <- meas_cities[meas_cities$city != 'Delhi', ]
```
### Plotting measurements
Plotting time series of PM 2.5 per location.

Using location_id...
```{r}

creadb::plot_measurements(meas_cities, poll=creadb::PM25, subplot_by='location_id')
```
... or location name
```{r}
creadb::plot_measurements(meas_cities, poll=creadb::PM25, subplot_by='location')
```

Plotting city-level values per pollutant
```{r}
creadb::plot_measurements(meas_cities, subplot_by='poll')
```
Using a 1-year rolling mean
```{r}
creadb::plot_measurements(meas_cities, running_days=365, subplot_by='poll')
```

Time series of PM2.5 per location (yearly running average)
```{r}
creadb::plot_measurements(meas_cities, poll=creadb::PM25, running_days=365, subplot_by='location')
```

Time series of PM2.5 per city (yearly running average)
```{r}
creadb::plot_measurements(meas_cities, poll=creadb::PM25, running_days=365, color_by='city')
```

Monthly average
```{r}
creadb::plot_measurements(meas_cities, poll=creadb::PM25, average_by='month', subplot_by='city')
```

Yearly average
```{r}
creadb::plot_measurements(meas_cities, poll=creadb::PM25, average_by='year', subplot_by='city')
```

Evolution over years of monthly data
```{r}
creadb::plot_measurements(meas_cities, poll=PM25, color_by='year', subplot_by='city', average_by='month')
```

Doing the same with all cities for PM10
```{r}
meas_month_all_cities <- creadb::measurements(country='IN', average_by='month', date_from='2014-01-01', poll=PM25)
creadb::plot_measurements(meas_month_all_cities, poll=PM25, color_by='year', subplot_by='city', average_by='month')
```
Heatmap per location with monthly data
```{r}
creadb::plot_measurements(meas_cities, poll=PM25, subplot_by='location', type='heatmap', average_by='month')
```

Heatmap per city weekly values
```{r}
creadb::plot_measurements(meas_cities, poll=PM25, subplot_by='city', type='heatmap', average_by='month')
```

## Standard exceedances

### Downloading standard exceedances
```{r}
exc_cities<- creadb::exceedances(country=c('IN'), city=c('Delhi', 'Jaipur', 'Mumbai', 'Hyderabad'))
exc_cities
```

### Plotting standard exceedances
Plot all

```{r}
creadb::plot_exceedances(exc_cities, average_by='week')
```

Plot only exceedances of 8-hour standards
```{r}
creadb::plot_exceedances(exc_cities[exc_cities$aggregation_period=='8-hour',], average_by='week')
```

Plot only exceedances of daily standards
```{r}
creadb::plot_exceedances(exc_cities[exc_cities$aggregation_period=='day',], average_by='week')
```

Plot only the year-based standards: in that case, the red indication mentions the day we know standard is going to bee breached this year, no mater how clean the air will be from then till the end of the year.

```{r}
creadb::plot_exceedances(exc_cities[exc_cities$aggregation_period=='year',], average_by='week')
```
Plot only exceedances of EU standards
```{r}
creadb::plot_exceedances(exc_cities[exc_cities$standard_org=='EU',], average_by='week')
```
Plot only exceedances happening last week
```{r}
creadb::plot_exceedances(exc_cities[exc_cities$date >= Sys.Date()-7 , ], average_by='day')
```
